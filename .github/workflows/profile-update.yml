name: Profile Auto-Update

on:
  schedule:
    # Runs every Monday at 9 AM UTC (6 AM Argentina time)
    - cron: '0 9 * * 1'
  workflow_dispatch:

jobs:
  update-profile:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout profile repository
        uses: actions/checkout@v4
        with:
          repository: LuisSambrano/LuisSambrano
          token: ${{ secrets.PROFILE_UPDATE_TOKEN }}
      
      - name: Checkout skills repository
        uses: actions/checkout@v4
        with:
          repository: LuisSambrano/antigravity-skills
          path: antigravity-skills
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install GitHub CLI
        run: |
          type -p gh >/dev/null || (
            curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | sudo dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg
            echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | sudo tee /etc/apt/sources.list.d/github-cli.list > /dev/null
            sudo apt update
            sudo apt install gh -y
          )
      
      - name: Fetch latest stats
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Get total repos
          TOTAL_REPOS=$(gh repo list LuisSambrano --limit 1000 --json name | jq '. | length')
          echo "TOTAL_REPOS=$TOTAL_REPOS" >> $GITHUB_ENV
          
          # Get repos created in last 7 days
          WEEK_AGO=$(date -d '7 days ago' +%Y-%m-%d)
          NEW_REPOS=$(gh repo list LuisSambrano --limit 1000 --json name,createdAt \
            | jq --arg date "$WEEK_AGO" '[.[] | select(.createdAt >= $date)] | length')
          echo "NEW_REPOS=$NEW_REPOS" >> $GITHUB_ENV
          
          # Get total Gists
          TOTAL_GISTS=$(gh gist list --limit 1000 | wc -l)
          echo "TOTAL_GISTS=$TOTAL_GISTS" >> $GITHUB_ENV
          
          # Get Gists created in last 7 days
          NEW_GISTS=$(gh gist list --limit 1000 | awk -v date="$(date -d '7 days ago' +%Y-%m-%d)" '$2 >= date' | wc -l)
          echo "NEW_GISTS=$NEW_GISTS" >> $GITHUB_ENV
          
          # Get active skills count
          ACTIVE_SKILLS=$(find antigravity-skills/.agent/skills/custom -name "SKILL.md" | wc -l)
          echo "ACTIVE_SKILLS=$ACTIVE_SKILLS" >> $GITHUB_ENV
          
          echo "ğŸ“Š Stats collected:"
          echo "  - Total Repos: $TOTAL_REPOS"
          echo "  - New Repos (7d): $NEW_REPOS"
          echo "  - Total Gists: $TOTAL_GISTS"
          echo "  - New Gists (7d): $NEW_GISTS"
          echo "  - Active Skills: $ACTIVE_SKILLS"
      
      - name: Get latest Gists
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Get 3 most recent Gists
          gh gist list --limit 3 | while read -r gist_id rest; do
            GIST_URL="https://gist.github.com/LuisSambrano/$gist_id"
            GIST_DESC=$(gh gist view $gist_id --raw | head -n 1 | sed 's/^# //')
            echo "$GIST_DESC|$GIST_URL" >> latest_gists.txt
          done
          
          if [ -f latest_gists.txt ]; then
            echo "ğŸ“ Latest Gists:"
            cat latest_gists.txt
          fi
      
      - name: Update README
        run: |
          python3 << 'PYTHON_SCRIPT'
          import os
          import re
          from datetime import datetime
          
          # Read environment variables
          total_repos = os.environ.get('TOTAL_REPOS', '0')
          new_repos = os.environ.get('NEW_REPOS', '0')
          total_gists = os.environ.get('TOTAL_GISTS', '0')
          new_gists = os.environ.get('NEW_GISTS', '0')
          active_skills = os.environ.get('ACTIVE_SKILLS', '0')
          
          # Read README
          with open('README.md', 'r') as f:
              content = f.read()
          
          # Update STATS section
          if '<!-- STATS:START -->' in content and '<!-- STATS:END -->' in content:
              stats_section = f"""<!-- STATS:START -->
          **ğŸ“Š Weekly Activity**
          - ğŸ“¦ Total Repositories: {total_repos}
          - ğŸ†• New Repos (7d): {new_repos}
          - ğŸ“ Total Gists: {total_gists}
          - âœ¨ New Gists (7d): {new_gists}
          - ğŸ› ï¸ Active Skills: {active_skills}
          
          *Last updated: {datetime.utcnow().strftime('%Y-%m-%d %H:%M UTC')}*
          <!-- STATS:END -->"""
              
              content = re.sub(
                  r'<!-- STATS:START -->.*?<!-- STATS:END -->',
                  stats_section,
                  content,
                  flags=re.DOTALL
              )
              print("âœ… Stats section updated")
          else:
              print("âš ï¸ No STATS section found in README")
          
          # Update GISTS section
          if os.path.exists('latest_gists.txt') and '<!-- GISTS:START -->' in content:
              gists_lines = ['<!-- GISTS:START -->']
              with open('latest_gists.txt', 'r') as f:
                  for line in f:
                      desc, url = line.strip().split('|')
                      gists_lines.append(f'- **[{desc}]({url})**')
              gists_lines.append('<!-- GISTS:END -->')
              
              gists_section = '\n'.join(gists_lines)
              content = re.sub(
                  r'<!-- GISTS:START -->.*?<!-- GISTS:END -->',
                  gists_section,
                  content,
                  flags=re.DOTALL
              )
              print("âœ… Gists section updated")
          
          # Write updated README
          with open('README.md', 'w') as f:
              f.write(content)
          PYTHON_SCRIPT
      
      - name: Commit and push changes
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          
          if git diff --quiet README.md; then
            echo "No changes to commit"
          else
            git add README.md
            git commit -m "chore: auto-update profile stats [skip ci]"
            git push
            echo "âœ… Profile README updated and pushed"
          fi
      
      - name: Create summary
        run: |
          echo "## ğŸ“Š Profile Update Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Stats Updated:**" >> $GITHUB_STEP_SUMMARY
          echo "- Total Repositories: ${{ env.TOTAL_REPOS }}" >> $GITHUB_STEP_SUMMARY
          echo "- New Repos (7d): ${{ env.NEW_REPOS }}" >> $GITHUB_STEP_SUMMARY
          echo "- Total Gists: ${{ env.TOTAL_GISTS }}" >> $GITHUB_STEP_SUMMARY
          echo "- New Gists (7d): ${{ env.NEW_GISTS }}" >> $GITHUB_STEP_SUMMARY
          echo "- Active Skills: ${{ env.ACTIVE_SKILLS }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Profile updated successfully!" >> $GITHUB_STEP_SUMMARY
